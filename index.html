<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Validador QR — Dia da Mulher</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:18px;max-width:760px}
    .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
    .ok{color:#0a7a2f;font-weight:800}
    .bad{color:#b00020;font-weight:800}
    .muted{color:#666}
    button{padding:10px 12px;border:0;border-radius:10px;cursor:pointer;background:#111;color:#fff}
    input{padding:10px 12px;border:1px solid #ccc;border-radius:10px;width:100%;max-width:420px}
    code{background:#f4f4f4;padding:2px 6px;border-radius:8px}
    #reader{width:100%;max-width:520px}
  </style>
</head>
<body>
  <h1>Validação de Convidados</h1>
  <p class="muted">O QR deve conter apenas o <b>código</b> (ex.: <code>ALICIA01</code>).</p>

  <div class="card">
    <button id="startBtn">Ler QR Code (abrir câmara)</button>
    <p id="msg" class="muted"></p>
    <div id="reader" style="display:none;"></div>
  </div>

  <div class="card">
    <h3>Resultado</h3>
    <div id="result" class="muted">Aguardando leitura…</div>
  </div>

  <div class="card">
    <h3>Plano B (manual)</h3>
    <input id="manual" placeholder="Código manual (ex: ALICIA01)" />
    <button id="manualBtn" style="margin-top:10px">Validar manualmente</button>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
  <script>
    const convidados = {
      "ALICIA01": "Alicia Reis",
      "ARIANA01": "Ariana Silva"
    };

    const msg = document.getElementById("msg");
    const result = document.getElementById("result");
    const reader = document.getElementById("reader");
    const startBtn = document.getElementById("startBtn");

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function mostrarResultado(raw){
      const code = String(raw || "").trim();
      const nome = convidados[code];
      if (nome){
        result.innerHTML = `<div class="ok">ESTÁ NA LISTA ✅</div><div><b>${escapeHtml(nome)}</b></div><div class="muted">Código: <code>${escapeHtml(code)}</code></div>`;
      } else {
        result.innerHTML = `<div class="bad">NÃO ESTÁ NA LISTA ❌</div><div class="muted">Lido: <code>${escapeHtml(code)}</code></div>`;
      }
    }

    let html5Qr = null;
    let running = false;

    async function start() {
      if (running) return;
      msg.textContent = "A pedir acesso à câmara…";
      reader.style.display = "block";
      if (!html5Qr) html5Qr = new Html5Qrcode("reader");

      const config = { fps: 10, qrbox: { width: 280, height: 280 } };

      // 1) Tenta a câmara traseira explicitamente (iPhone)
      try {
        running = true;
        await html5Qr.start({ facingMode: { exact: "environment" } }, config, (txt) => {
          mostrarResultado(txt);
        });
        msg.textContent = "Câmara ligada. Aponta para o QR.";
        return;
      } catch (e1) {
        // 2) Fallback: pede environment sem exact
      }

      try {
        await html5Qr.start({ facingMode: "environment" }, config, (txt) => {
          mostrarResultado(txt);
        });
        msg.textContent = "Câmara ligada. Aponta para o QR.";
        running = true;
      } catch (e2) {
        running = false;
        msg.textContent = "Bloqueado no iPhone. Fecha o Safari, abre de novo e confirma permissões (Definições → Safari → Câmara).";
      }
    }

    startBtn.addEventListener("click", start);

    document.getElementById("manualBtn").addEventListener("click", () => {
      mostrarResultado(document.getElementById("manual").value);
    });
  </script>
</body>
</html>
